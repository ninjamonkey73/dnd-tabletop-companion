<div class="layout">
  <app-header
    [selectedCharacter]="selectedCharacter"
    [savedCharacterNames]="savedCharacterNames"
    [isCreatingNewCharacter]="isCreatingNewCharacter"
    [fullHeal]="fullHeal"
    [character]="character"
    [classes]="classes"
    (characterSelected)="onCharacterSelection($event)"
    (deleteCharacter)="deleteCharacter($event)"
    (shortRest)="shortRest()"
    (longRest)="longRest()"
    (fullHealChange)="onFullHealToggle($event)"
    (classSelected)="onHeaderClassSelected($event)"
    (levelChanged)="onHeaderLevelChanged($event)"
  ></app-header>

  @if (isCreatingNewCharacter) {
  <div class="newChar">
    <mat-form-field appearance="fill">
      <mat-label>New Character Name</mat-label>
      <input
        matInput
        name="newCharacterName"
        type="text"
        [(ngModel)]="newCharacterName"
        autocomplete="off"
      />
    </mat-form-field>
    <button
      class="save-button"
      mat-raised-button
      color="primary"
      (click)="createNewCharacter()"
    >
      Save Character
    </button>
    <button
      class="cancel-button"
      mat-raised-button
      color="primary"
      (click)="cancelNewCharacter()"
    >
      Cancel
    </button>
  </div>
  }

  <app-hp
    [character]="character"
    [isCreatingNewCharacter]="isCreatingNewCharacter"
    [percentHP]="percentHP"
    [deathSaveMessage]="deathSaveMessage"
    [isCharacterLoaded]="isCharacterLoaded"
    (characterChange)="onChildCharacterChange()"
    (hurt)="onHurt($event)"
    (heal)="onHeal($event)"
    (maxHpEditFinished)="onMaxHpEditFinished()"
  ></app-hp>
  <mat-button-toggle-group
    [value]="showingMoney ? 'money' : 'resources'"
    (change)="onSectionToggle($event.value)"
  >
    <mat-button-toggle value="money">Money</mat-button-toggle>
    <mat-button-toggle value="resources">Trackable Resources</mat-button-toggle>
  </mat-button-toggle-group>

  <div class="row money-row" [attr.aria-disabled]="isCreatingNewCharacter">
    @if (showingMoney) {
    <app-money
      [character]="character"
      [isCreatingNewCharacter]="isCreatingNewCharacter"
      (characterChange)="onChildCharacterChange()"
    ></app-money>
    } @if (!showingMoney) {
    <app-resources
      [character]="character"
      [isCreatingNewCharacter]="isCreatingNewCharacter"
      (characterChange)="onChildCharacterChange()"
    ></app-resources>
    }
  </div>

  <!-- Stat section toggle: show when 2+ sections available -->
  @if (availableStatSectionsSig().length > 1) {
  <div class="body-buttons">
    @for (sec of availableStatSectionsSig(); track sec) {
    <button
      mat-stroked-button
      color="primary"
      [disabled]="selectedStatSection === sec"
      (click)="setSelectedStatSection(sec)"
    >
      {{
        sec === "ki"
          ? "Ki Points"
          : sec === "rage"
          ? "Rage"
          : sec === "wild"
          ? "Wild Shape"
          : "Spell Slots"
      }}
    </button>
    }
  </div>
  }

  <!-- Render selected stat section only -->
  @if (selectedStatSection === 'ki') {
  <app-ki-points
    [character]="character"
    [isCreatingNewCharacter]="isCreatingNewCharacter"
    (characterChange)="onChildCharacterChange()"
  ></app-ki-points>
  } @if (selectedStatSection === 'wild') {
  <app-wild-shape
    [character]="character"
    [isCreatingNewCharacter]="isCreatingNewCharacter"
    (characterChange)="onChildCharacterChange()"
  ></app-wild-shape>
  } @if (selectedStatSection === 'slots') {
  <app-spell-slots
    [character]="character"
    [isCreatingNewCharacter]="isCreatingNewCharacter"
    (characterChange)="onChildCharacterChange()"
    (remainingChanged)="onSpellSlotRemainingChanged($event)"
  ></app-spell-slots>
  } @if (selectedStatSection === 'rage') {
  <app-rage
    [character]="character"
    [isCreatingNewCharacter]="isCreatingNewCharacter"
    (characterChange)="onChildCharacterChange()"
  ></app-rage>
  }

  <mat-button-toggle-group
    [value]="showingDeathSaves ? 'death' : 'hit'"
    (change)="onDeathHitToggle($event.value)"
  >
    <mat-button-toggle value="death">Death Saves</mat-button-toggle>
    <mat-button-toggle value="hit">Hit Dice</mat-button-toggle>
  </mat-button-toggle-group>

  <div>
    @if (showingDeathSaves) {
    <app-death-saves
      [character]="character"
      (deathSaveMessageChange)="deathSaveMessage = $event"
      (characterChange)="onChildCharacterChange()"
    ></app-death-saves>
    } @if (!showingDeathSaves) {
    <app-hit-dice
      [character]="character"
      [isCreatingNewCharacter]="isCreatingNewCharacter"
      (characterChange)="onChildCharacterChange()"
    ></app-hit-dice>
    }
  </div>
</div>
